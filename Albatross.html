<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Albatross Visualization</title>
  <script src="../Build/Cesium/Cesium.js"></script>
  <style>
      @import url(../Build/Cesium/Widgets/widgets.css);
      html, body, #cesiumContainer {
          width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      }
      .myContainer1 span{
        display: inline-block;
      }
  </style>
</head>
<body>
  <div class="myContainer1">
    <select id="list1" onchange="setSelectedID();" >
      <option value="null">< All Animals ></option>
      <option value="0">ID 1</option>
      <option value="1">ID 2</option>
      <option value="2">ID 3</option>
      <option value="3">ID 4</option>
      <option value="4">ID 5</option>
    </select>
    <select id="list2" onchange="setSelectedColor();" >
      <option value="null">< select Color ></option>
      <option value="0">Color 1</option>
      <option value="1">Color 2</option>
      <option value="2">Color 3</option>
      <option value="3">Color 4</option>
      <option value="4">Color 5</option>
    </select>
    <span id="slidecontainer" >
      <span>Line Width: <span id="lineW" style="width: 40px"></span></span>
      <input type="range" min="1" max="50" value="10" class="slider" id="myRange1">
      <span>Transparency:  <span  id="lineT" style="width: 20px"></span> %</span>
      <input type="range" min="0" max="100" value="50" class="slider" id="myRange2">
    </span>
  </div>
  <div id="cesiumContainer"></div>


  <script>


    var viewer = new Cesium.Viewer('cesiumContainer', {
        animation : false,
        timeline : false
    });

    viewer.clock.shouldAnimate = false;

    var options = {
        camera : viewer.scene.camera,
        canvas : viewer.scene.canvas
    };

    var colors1 = ['#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33'];
    var colors2 = ['#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854'];
    var colorsDeriving = ['#a50026','#d73027','#f46d43','#fdae61','#fee08b','#d9ef8b','#a6d96a','#66bd63','#1a9850','#006837'];
    var colorsSequential = ['#fef0d9','#fdcc8a','#fc8d59','#e34a33','#b30000'];
    var colorStrArr = colors1;
    var iterateID = 0;
    var totalAnimalCount = 28;
    var firstKMLload = true;
    var firstKMLloadArr = [true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true ];
    var firstStationload = true;
    var lineColor = Cesium.Color.fromCssColorString(colorStrArr[2]);
    var lineWidth = 1;
    var alpha = 0.5;
    var animalIdShow = null; //null means all Animals are shown
    var slider1 = document.getElementById("myRange1");
    var output1 = document.getElementById("lineW");
    var slider2 = document.getElementById("myRange2");
    var output2 = document.getElementById("lineT");
    output1.innerHTML = String(lineWidth);
    output2.innerHTML = String(alpha * 100);
    var kmlPromises = [];

    for (var i = 0; i < 28; i++) {
        var folderName = i+1;
        kmlPromises[i] = Cesium.KmlDataSource.load('SampleData/albatross/' + folderName + '/line.kml', options);
    }



    var cesiumTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
        url : 'https://assets.agi.com/stk-terrain/v1/tilesets/world/tiles',
        requestWaterMask : true,
        requestVertexNormals : false
    });

    //viewer.terrainProvider = cesiumTerrainProviderMeshes;







    var polyLineEntity;
    //var kmlPromise = Cesium.KmlDataSource.load('SampleData/albatross/doc.kml', options);
    var stationPromise = Cesium.KmlDataSource.load('SampleData/albatross/airports.kml', options);


    drawKML();


    //styleKML(kmlPromise, lineColor, lineWidth, alpha);
    styleStations(stationPromise);





    slider1.oninput = function() {
        lineWidth = Math.pow(Number(this.value)/10,2).toFixed(2);
        output1.innerHTML = String(lineWidth);
        drawKML(animalIdShow);
    }

    slider2.oninput = function() {
        alpha = Number(this.value);
        output2.innerHTML = String(alpha);
        alpha = Number(this.value)/100;
        drawKML(animalIdShow);
    }


    function drawKML (animalID) {
        for (var i = 0; i < 28; i++) {
            var fileNr = i+1;
            if (animalID == null || animalID == i) {
                console.log("lineColor= " + lineColor );
                styleKML(kmlPromises[i], lineColor, lineWidth, alpha, i);
            }
        }
    }


    function styleKML(kmlPromise, lineColor, lineWidth, alpha, currentCount) {

        // Add kml entities to scene and style them
        kmlPromises[currentCount].then(function (dataSource) {

            // Add the new data as entities to the viewer
            if (firstKMLloadArr[currentCount]){
                viewer.dataSources.add(dataSource);
                firstKMLloadArr[currentCount] = false;
            }

            // Get the array of entities
            var kmlEntities = dataSource.entities.values;
            console.log("Entity.length = " + kmlEntities.length);
            for (var i = 0; i < kmlEntities.length; i++) {
                var entity = kmlEntities[i];
                if (Cesium.defined(entity.polyline)) {
                    console.log("AnimalID = " + iterateID++);
                    iterateID %= totalAnimalCount;
                    entity.polyline.material = lineColor.withAlpha(alpha);
                    entity.polyline.width = lineWidth;
                }
            }
        });
    }

    function styleStations (stationPromise) {
        //Add Weatherstations to scene and style them
        stationPromise.then(function (dataSource) {

            if (firstStationload){
                viewer.dataSources.add(dataSource);
                firstStationload = false;
            }

            var stationEntities = dataSource.entities.values;

            for (var i = 0; i < stationEntities.length; i++) {
                var entity = stationEntities[i];
                if (Cesium.defined(entity.billboard)) {
                    entity.billboard.image = 'SampleData/W_wind.png';
                    // winddirection(degree) + 270 is the offset
                    entity.billboard.rotation = Cesium.Math.RADIANS_PER_DEGREE * ((i-1)*45 + 270);

                }
            }
        })
    }

    function setSelectedColor()
    {
        var selectedInt = Number(document.getElementById("list2").value);
        var returnString;

        if (Number.isInteger(selectedInt) && selectedInt < colorStrArr.length) {
            returnString = colorStrArr[selectedInt];
        } else {
            alert("No Color selected");
            returnString = '#ffffff';
            console.log("not a Number or Out Of Bounds @ColorStrArr")
        }

        lineColor = Cesium.Color.fromCssColorString(returnString);
        drawKML(animalIdShow);

    }

    function setSelectedID()
    {
        var selectedInt = Number(document.getElementById("list1").value);
        var returnString;

        if (Number.isInteger(selectedInt) && selectedInt < totalAnimalCount) {
            animalIdShow = selectedInt;
        } else {
            animalIdShow = null;// All Animals
            console.log("All Animals selected OR Out Of Bounds @TotalAnimalCount")
        }

        drawKML(animalIdShow);

    }

    /*
    function setSelectedTrans()
    {
        var selectedTrans = document.getElementById("list2").value;
        if (selectedTrans == "0") {
            styleKML(kmlPromise, lineColor, lineWidth, 0);
            alpha = 0;
        } else if (selectedTrans == "0.25") {
            styleKML(kmlPromise, lineColor, lineWidth, 0.25);
            alpha = 0.25;
        } else if (selectedTrans == "0.5") {
            styleKML(kmlPromise, lineColor, lineWidth, 0.5);
            alpha = 0.5;
        } else {
            styleKML(kmlPromise, lineColor, lineWidth, 1.0);
            alpha = 1.0;
        }
    }

    function setSelectedWidth()
    {
        var selectedWidth = document.getElementById("list3").value;

        if (selectedWidth == "0.5") {
            lineWidth = 0.5;
        } else if (selectedWidth == "1.0") {
            lineWidth = 1.0;
        } else if (selectedWidth == "2.0") {
            lineWidth = 2.0;
        } else {
            lineWidth = 3.0;
        }

        styleKML(kmlPromise, lineColor, lineWidth, alpha);
    }
    */




  </script>
</body>
</html>
